<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Consultas ‚Äî Sistema UBS</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header>
    <nav class="nav">
        <a href="/" class="nav-link">In√≠cio</a>
        <a href="/register" class="nav-link">Cadastre-se</a>
        <img src="/static/images/ubs.png" class="nav-logo">
    </nav>
</header>

<main class="center-box">
    <h1>Gerenciar Consultas</h1>

    <div class="form-card">
        <button id="btnBuscar" class="btn" type="button">Buscar Consultas</button>
        <button id="btnCriar" class="btn" type="button">Criar Consulta</button>
    </div>

    <form id="formBuscar" class="form-card" style="display:none; margin-top:20px;">
        <h2>Buscar Consultas</h2>
        <label>Buscar por:</label>
        <select name="tipo_busca" required>
            <option value="">Selecione...</option>
            <option value="patient_cpf">CPF do Paciente</option>
            <option value="doctor_cpf">CPF do M√©dico</option>
            <option value="ubs_cnes">CNES da UBS</option>
            <option value="datetime">Data</option>
        </select>
        <label>Valor:</label>
        <input type="text" name="valor" placeholder="Digite o valor da busca (ex: CPF, CNES, Data)" required>
        <button type="submit" class="btn">Buscar</button>
    </form>

    <div id="resultadoBusca" class="form-card" style="display:none; margin-top:20px;"></div>

    <form id="formCriar" class="form-card" style="display:none; margin-top:20px;">
        <h2>Criar Nova Consulta</h2>
        
        <label>CPF do Paciente:</label>
        <input type="text" name="patient_cpf" placeholder="00000000000" inputmode="numeric" maxlength="11" required>
        
        <label>CPF do M√©dico:</label>
        <input type="text" name="doctor_cpf" placeholder="00000000000" inputmode="numeric" maxlength="11" required>
        
        <label>CNES da UBS:</label>
        <input type="text" name="ubs_cnes" placeholder="1234567" inputmode="numeric" maxlength="7" required>
        
        <label>Data e Hora:</label>
        <input type="datetime-local" name="appointment_datetime" required>
        
        <button type="submit" class="btn">Cadastrar Consulta</button>
    </form>

    <div id="mensagemCriar" style="margin-top:10px;"></div>

</main>

<script>
/**
 * Utilit√°rio 1: Formata a data vinda do backend (agora esperado em ISO 8601) para exibi√ß√£o PT-BR.
 */
function formatAppointmentDateTime(dateString) {
    if (!dateString) {
        return 'N/A';
    }
    const cleanDateString = dateString.replace(' ', 'T'); 
    const dataObj = new Date(cleanDateString);
    
    if (isNaN(dataObj.getTime())) {
        return `Erro de Data: ${dateString.substring(0, 19)}`;
    }
    
    return dataObj.toLocaleDateString('pt-BR') + ' ' + dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
}

/**
 * Fun√ß√µes de A√ß√£o
 */

// üü¢ IMPLEMENTA√á√ÉO DA FUN√á√ÉO DE EXCLUS√ÉO üü¢
async function deleteAppointment(id) {
    if (!confirm(`Tem certeza que deseja excluir a consulta ID ${id}? Esta a√ß√£o √© irrevers√≠vel.`)) {
        return;
    }

    const resultadoBusca = document.getElementById('resultadoBusca');
    resultadoBusca.innerHTML = `<p style="color: blue;">‚è≥ Excluindo consulta ID ${id}...</p>`;

    try {
        const response = await fetch(`/appointments/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();
        
        if (response.ok) {
            const successMessage = data.message || `Consulta ID ${id} exclu√≠da com sucesso!`;
            resultadoBusca.innerHTML = `<p style="color: green; font-weight: bold;">‚úÖ ${successMessage}</p>`;
            
            // Recarrega a tabela ou remove a linha exclu√≠da (para simplificar, vamos apenas buscar novamente)
            document.getElementById('formBuscar').dispatchEvent(new Event('submit'));

        } else {
            let errorMessage = data.detail || data.message || `Erro desconhecido. Status: ${response.status}`;
            resultadoBusca.innerHTML = `<p style="color: red; font-weight: bold;">‚ùå Erro ao excluir: ${errorMessage}</p>`;
        }
    } catch (error) {
        console.error('Erro de conex√£o ao excluir:', error);
        resultadoBusca.innerHTML = `<p style="color: red;">‚ö†Ô∏è Erro de rede: Falha ao conectar com o servidor.</p>`;
    }
}

// Fun√ß√£o para anexar os Listeners de A√ß√£o (Editar e Excluir)
function attachActionListeners() {
    // Listener para Excluir
    document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            deleteAppointment(id);
        });
    });

    // Listener para Editar
    document.querySelectorAll('.btn-edit').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            // Implementa√ß√£o da Edi√ß√£o Pendente
            alert(`Funcionalidade de Edi√ß√£o (ID ${id}) a ser implementada.`);
        });
    });
}


document.addEventListener('DOMContentLoaded', function() {
    // 1. Obter refer√™ncias aos elementos HTML
    const btnBuscar = document.getElementById('btnBuscar');
    const btnCriar = document.getElementById('btnCriar');
    const formBuscar = document.getElementById('formBuscar');
    const formCriar = document.getElementById('formCriar');
    const resultadoBusca = document.getElementById('resultadoBusca');
    const mensagemCriar = document.getElementById('mensagemCriar');

    // 2. Fun√ß√£o para alternar a exibi√ß√£o dos formul√°rios
    function toggleForms(formToShow, formToHide) {
        formToHide.style.display = 'none';
        formToShow.style.display = 'block';

        if (formToShow === formBuscar) {
            mensagemCriar.innerHTML = '';
        } else if (formToShow === formCriar) {
            resultadoBusca.style.display = 'none';
        }
    }

    // 3. Listeners para os bot√µes de altern√¢ncia
    btnBuscar.addEventListener('click', function() {
        toggleForms(formBuscar, formCriar);
    });

    btnCriar.addEventListener('click', function() {
        toggleForms(formCriar, formBuscar);
    });

    // --- 4. L√≥gica de Busca (ATUALIZADA PARA INCLUIR BOT√ïES DE A√á√ÉO) ---
    formBuscar.addEventListener('submit', async function(event) {
        event.preventDefault(); 
        const tipoBusca = this.querySelector('select[name="tipo_busca"]').value;
        const valorBusca = this.querySelector('input[name="valor"]').value.trim();

        resultadoBusca.innerHTML = '<p style="color: blue;">üîç Buscando consultas...</p>';
        resultadoBusca.style.display = 'block';

        try {
            const url = `/appointments/search?tipo_busca=${tipoBusca}&valor=${valorBusca}`;
            const response = await fetch(url);
            const data = await response.json(); 
            
            if (response.ok) {
                if (data && data.length > 0) {
                    let htmlTabela = '<h3>Consultas Encontradas</h3>';
                    htmlTabela += '<table class="data-table"><thead><tr><th>ID</th><th>CPF Paciente</th><th>CPF M√©dico</th><th>Data/Hora</th><th>A√ß√µes</th></tr></thead><tbody>';
                    
                    data.forEach(consulta => {
                        const dataFormatada = formatAppointmentDateTime(consulta.appointment_datetime);
                        
                        htmlTabela += `
                            <tr>
                                <td>${consulta.id}</td>
                                <td>${consulta.patient_cpf}</td>
                                <td>${consulta.doctor_cpf}</td>
                                <td>${dataFormatada}</td>
                                <td>
                                    <button class="btn btn-sm btn-edit" data-id="${consulta.id}">Editar</button> 
                                    <button class="btn btn-sm btn-delete" data-id="${consulta.id}">Excluir</button>
                                </td>
                            </tr>
                        `;
                    });
                    htmlTabela += '</tbody></table>';
                    resultadoBusca.innerHTML = htmlTabela;
                    
                    // üéØ CHAMA A FUN√á√ÉO PARA ADICIONAR OS EVENTOS AOS NOVOS BOT√ïES
                    attachActionListeners(); 
                    
                } else {
                    resultadoBusca.innerHTML = '<p>Nenhuma consulta encontrada com os crit√©rios fornecidos.</p>';
                }
            } else {
                let errorMessage;
                if (data && typeof data === 'object') {
                    errorMessage = data.detail || data.message || `API Error: ${JSON.stringify(data, null, 2)}`;
                } else {
                    errorMessage = data ? data.toString() : 'Falha desconhecida na busca.';
                }
                resultadoBusca.innerHTML = `<p style="color: red; white-space: pre-wrap;">‚ùå Erro na API: ${errorMessage}</p>`;
            }
        } catch (error) {
            console.error('Erro de conex√£o:', error);
            const displayError = error.message || error.toString() || 'Verifique se o servidor est√° ativo.';
            resultadoBusca.innerHTML = `<p style="color: red;">‚ö†Ô∏è Erro de rede: ${displayError}</p>`;
        }
    });

    // --- 5. L√≥gica de Cria√ß√£o (CORRIGIDA - Inalterada aqui) ---
    formCriar.addEventListener('submit', async function(event) {
        event.preventDefault(); 

        mensagemCriar.innerHTML = '<p style="color: blue; font-weight: bold;">‚è≥ Processando o cadastro...</p>';
        
        const localDatetimeString = this.querySelector('input[name="appointment_datetime"]').value;
        let formattedISOString = '';
        
        if (localDatetimeString && localDatetimeString.length >= 16) {
            const dateObj = new Date(localDatetimeString);
            
            if (!isNaN(dateObj.getTime())) {
                formattedISOString = dateObj.toISOString(); 
            } else {
                 mensagemCriar.innerHTML = '<p style="color: red; font-weight: bold;">‚ùå Erro: Formato de Data/Hora inv√°lido. Use o seletor de calend√°rio.</p>';
                 return;
            }
        } else {
            mensagemCriar.innerHTML = '<p style="color: red; font-weight: bold;">‚ùå Erro: Por favor, preencha a data e hora corretamente.</p>';
            return;
        }
        
        console.log('Valor enviado ao backend (ISO 8601 Z):', formattedISOString);

        const formData = {
            patient_cpf: this.querySelector('input[name="patient_cpf"]').value,
            doctor_cpf: this.querySelector('input[name="doctor_cpf"]').value,
            ubs_cnes: this.querySelector('input[name="ubs_cnes"]').value,
            appointment_datetime: formattedISOString, 
            date: formattedISOString // Necess√°rio para contornar o Pydantic
        };

        try {
            const response = await fetch('/appointments/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();

            if (response.ok) {
                const successMessage = data.message || 'Consulta cadastrada com sucesso!';
                mensagemCriar.innerHTML = `<p style="color: green; font-weight: bold;">‚úÖ ${successMessage}</p>`;
                this.reset();
            } else {
                let errorMessage;
                if (data && data.detail) {
                    errorMessage = data.detail.map(err => `${err.loc.join('. ')}: ${err.msg}`).join('\n');
                } else if (data && data.message) {
                    errorMessage = data.message;
                } else {
                    errorMessage = `Erro desconhecido. Status: ${response.status} - ${JSON.stringify(data, null, 2)}`;
                }
                
                mensagemCriar.innerHTML = `<p style="color: red; font-weight: bold; white-space: pre-wrap;">‚ùå Erro: ${errorMessage}</p>`;
            }
        } catch (error) {
            console.error('Erro de conex√£o:', error);
            const displayError = error.message || error.toString() || 'Verifique a conex√£o com o servidor.';
            mensagemCriar.innerHTML = `<p style="color: red;">‚ö†Ô∏è Erro de rede: ${displayError}</p>`;
        }
    });
});
</script>
</body>
</html>