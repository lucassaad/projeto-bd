<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <title>Consultas â€” Sistema UBS</title>
Â  Â  <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<header>
Â  Â  <nav class="nav">
Â  Â  Â  Â  <a href="/" class="nav-link">InÃ­cio</a>
Â  Â  Â  Â  <a href="/register" class="nav-link">Cadastre-se</a>
Â  Â  Â  Â  <img src="/static/images/ubs.png" class="nav-logo">
Â  Â  </nav>
</header>

<main class="center-box">
Â  Â  <h1>Gerenciar Consultas</h1>

Â  Â  <div class="form-card">
Â  Â  Â  Â  <button id="btnBuscar" class="btn" type="button">Buscar Consultas</button>
Â  Â  Â  Â  <button id="btnCriar" class="btn" type="button">Criar Consulta</button>
Â  Â  </div>

Â  Â  <form id="formBuscar" class="form-card" style="display:none; margin-top:20px;">
Â  Â  Â  Â  <h2>Buscar Consultas</h2>
Â  Â  Â  Â  <label>Buscar por:</label>
Â  Â  Â  Â  <select name="tipo_busca" required>
Â  Â  Â  Â  Â  Â  <option value="">Selecione...</option>
Â  Â  Â  Â  Â  Â  <option value="patient_cpf">CPF do Paciente</option>
Â  Â  Â  Â  Â  Â  <option value="doctor_cpf">CPF do MÃ©dico</option>
Â  Â  Â  Â  Â  Â  <option value="ubs_cnes">CNES da UBS</option>
Â  Â  Â  Â  Â  Â  <option value="datetime">Data</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <label>Valor:</label>
Â  Â  Â  Â  <input type="text" name="valor" placeholder="Digite o valor da busca (ex: CPF, CNES, Data)" required>
Â  Â  Â  Â  <button type="submit" class="btn">Buscar</button>
Â  Â  </form>

Â  Â  <div id="resultadoBusca" class="form-card" style="display:none; margin-top:20px;"></div>

Â  Â  <form id="formCriar" class="form-card" style="display:none; margin-top:20px;">
Â  Â  Â  Â  <h2>Criar Nova Consulta</h2>
Â  Â  Â  Â  <label>CPF do Paciente:</label>
Â  Â  Â  Â  <input type="text" name="cpf_paciente" placeholder="00000000000" inputmode="numeric" maxlength="11" required>
Â  Â  Â  Â  <label>CPF do MÃ©dico:</label>
Â  Â  Â  Â  <input type="text" name="cpf_medico" placeholder="00000000000" inputmode="numeric" maxlength="11" required>
Â  Â  Â  Â  <label>CNES da UBS:</label>
Â  Â  Â  Â  <input type="text" name="cnes_ubs" placeholder="1234567" inputmode="numeric" maxlength="7" required>
Â  Â  Â  Â  <label>Data e Hora:</label>
Â  Â  Â  Â  <input type="datetime-local" name="data_hora" required>
Â  Â  Â  Â  <button type="submit" class="btn">Cadastrar Consulta</button>
Â  Â  </form>

Â  Â  <div id="mensagemCriar" style="margin-top:10px;"></div>

</main>

<script>
/**
 * UtilitÃ¡rio 1: Formata a data vinda do backend (YYYY-MM-DD HH:MM:SS.ms) para exibiÃ§Ã£o.
 */
function formatAppointmentDateTime(dateString) {
    if (!dateString) {
        return 'N/A';
    }
    // Padroniza a string: Substitui o espaÃ§o por 'T' para aderir ao formato ISO 8601, ignorando milissegundos para new Date()
    const cleanDateString = dateString.replace(' ', 'T'); 
    const dataObj = new Date(cleanDateString);
    
    if (isNaN(dataObj.getTime())) {
        return `Erro de Data: ${dateString.substring(0, 19)}`;
    }
    
    return dataObj.toLocaleDateString('pt-BR') + ' ' + dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second: '2-digit'});
}

/**
 * UtilitÃ¡rio 2: Converte o formato do input datetime-local (YYYY-MM-DDTHH:MM) 
 * para o formato do backend (YYYY-MM-DD HH:MM:00.000).
 */
function formatToBackendDatetime(localDatetimeString) {
    if (!localDatetimeString || localDatetimeString.length < 16) {
        return '';
    }
    // 1. Substitui 'T' por espaÃ§o.
    const baseFormat = localDatetimeString.replace('T', ' ');
    // 2. Adiciona segundos e milissegundos zerados.
    return `${baseFormat}:00.000`; 
}


document.addEventListener('DOMContentLoaded', function() {
Â  Â  // 1. Obter referÃªncias aos elementos HTML
Â  Â  const btnBuscar = document.getElementById('btnBuscar');
Â  Â  const btnCriar = document.getElementById('btnCriar');
Â  Â  const formBuscar = document.getElementById('formBuscar');
Â  Â  const formCriar = document.getElementById('formCriar');
Â  Â  const resultadoBusca = document.getElementById('resultadoBusca');
Â  Â  const mensagemCriar = document.getElementById('mensagemCriar');

Â  Â  // 2. FunÃ§Ã£o para alternar a exibiÃ§Ã£o dos formulÃ¡rios
Â  Â  function toggleForms(formToShow, formToHide) {
Â  Â  Â  Â  formToHide.style.display = 'none';
Â  Â  Â  Â  formToShow.style.display = 'block';

Â  Â  Â  Â  if (formToShow === formBuscar) {
Â  Â  Â  Â  Â  Â  mensagemCriar.innerHTML = '';
Â  Â  Â  Â  } else if (formToShow === formCriar) {
Â  Â  Â  Â  Â  Â  resultadoBusca.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 3. Listeners para os botÃµes de alternÃ¢ncia
Â  Â  btnBuscar.addEventListener('click', function() {
Â  Â  Â  Â  toggleForms(formBuscar, formCriar);
Â  Â  });

Â  Â  btnCriar.addEventListener('click', function() {
Â  Â  Â  Â  toggleForms(formCriar, formBuscar);
Â  Â  });

Â  Â  // --- 4. LÃ³gica de Busca: Recebe JSON e Monta a Tabela ---
Â  Â  formBuscar.addEventListener('submit', async function(event) {
Â  Â  Â  Â  event.preventDefault(); 

Â  Â  Â  Â  const tipoBusca = this.querySelector('select[name="tipo_busca"]').value;
Â  Â  Â  Â  const valorBusca = this.querySelector('input[name="valor"]').value.trim();

Â  Â  Â  Â  // Estado de Carregamento
Â  Â  Â  Â  resultadoBusca.innerHTML = '<p style="color: blue;">ğŸ” Buscando consultas...</p>';
Â  Â  Â  Â  resultadoBusca.style.display = 'block';

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const url = `/appointments/search?tipo_busca=${tipoBusca}&valor=${valorBusca}`;
Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  const data = await response.json(); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  // Sucesso (Status 200 OK)
Â  Â  Â  Â  Â  Â  Â  Â  if (data && data.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let htmlTabela = '<h3>Consultas Encontradas</h3>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlTabela += '<table class="data-table"><thead><tr><th>ID</th><th>CPF Paciente</th><th>CPF MÃ©dico</th><th>Data/Hora</th><th>AÃ§Ãµes</th></tr></thead><tbody>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.forEach(consulta => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ğŸ¯ USA O UTILITÃRIO formatAppointmentDateTime
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dataFormatada = formatAppointmentDateTime(consulta.data_hora);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlTabela += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${consulta.id}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${consulta.patient_cpf}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${consulta.doctor_cpf}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${dataFormatada}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm" onclick="alert('Editar consulta ${consulta.id}')">Editar</button> 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm" onclick="alert('Excluir consulta ${consulta.id}')">Excluir</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  htmlTabela += '</tbody></table>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultadoBusca.innerHTML = htmlTabela;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resultadoBusca.innerHTML = '<p>Nenhuma consulta encontrada com os critÃ©rios fornecidos.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // ğŸ¯ Tratamento de Erro de Busca Melhorado
Â  Â  Â  Â  Â  Â  Â  Â  let errorMessage;
                if (data && typeof data === 'object') {
                    errorMessage = data.detail || data.message || `API Error: ${JSON.stringify(data, null, 2)}`;
                } else {
                    errorMessage = data ? data.toString() : 'Falha desconhecida na busca.';
                }
Â  Â  Â  Â  Â  Â  Â  Â  resultadoBusca.innerHTML = `<p style="color: red; white-space: pre-wrap;">âŒ Erro na API: ${errorMessage}</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  // Erro de ConexÃ£o ou Rede
Â  Â  Â  Â  Â  Â  console.error('Erro de conexÃ£o:', error);
Â  Â  Â  Â  Â  Â  resultadoBusca.innerHTML = `<p style="color: red;">âš ï¸ Erro de rede: Verifique se o servidor estÃ¡ ativo.</p>`;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- 5. LÃ³gica de CriaÃ§Ã£o ---
Â  Â  formCriar.addEventListener('submit', async function(event) {
Â  Â  Â  Â  event.preventDefault(); 

Â  Â  Â  Â  mensagemCriar.innerHTML = '<p style="color: blue; font-weight: bold;">â³ Processando o cadastro...</p>';
        
        // ğŸ¯ Captura o valor bruto do input datetime-local
        const rawDataHora = this.querySelector('input[name="data_hora"]').value;

        // ğŸ¯ CONVERTE PARA O FORMATO EXIGIDO PELO BACKEND (YYYY-MM-DD HH:MM:00.000)
        const formattedDataHora = formatToBackendDatetime(rawDataHora);
        
        // DEBUG: Mostra o formato que serÃ¡ enviado no console do navegador (F12)
        console.log('Valor enviado ao backend (formatado):', formattedDataHora);


Â  Â  Â  Â  const formData = {
Â  Â  Â  Â  Â  Â  patient_cpf: this.querySelector('input[name="cpf_paciente"]').value,
Â  Â  Â  Â  Â  Â  doctor_cpf: this.querySelector('input[name="cpf_medico"]').value,
Â  Â  Â  Â  Â  Â  ubs_cnes: this.querySelector('input[name="cnes_ubs"]').value,
Â  Â  Â  Â  Â  Â  // ğŸ¯ Envia o valor formatado
Â  Â  Â  Â  Â  Â  data_hora: formattedDataHora 
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch('/appointments/', {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(formData)
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
            const data = await response.json();

Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  const successMessage = data.message || 'Consulta cadastrada com sucesso!';
Â  Â  Â  Â  Â  Â  Â  Â  mensagemCriar.innerHTML = `<p style="color: green; font-weight: bold;">âœ… ${successMessage}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  this.reset();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // ğŸ¯ Tratamento de Erro de CriaÃ§Ã£o Melhorado (Exibe o JSON completo)
Â  Â  Â  Â  Â  Â  Â  Â  let errorMessage;
                if (data && typeof data === 'object') {
                    errorMessage = data.detail || data.message || `API Error: ${JSON.stringify(data, null, 2)}`;
                } else {
                    errorMessage = data.toString() || 'Erro ao cadastrar.';
                }
Â  Â  Â  Â  Â  Â  Â  Â  mensagemCriar.innerHTML = `<p style="color: red; font-weight: bold; white-space: pre-wrap;">âŒ Erro: ${errorMessage}</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Erro de conexÃ£o:', error);
Â  Â  Â  Â  Â  Â  mensagemCriar.innerHTML = `<p style="color: red;">âš ï¸ Erro de rede: Verifique a conexÃ£o com o servidor.</p>`;
Â  Â  Â  Â  }
Â  Â  });
});
</script>
</body>
</html>